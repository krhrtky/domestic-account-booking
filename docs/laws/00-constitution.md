# 00. 基本原則 (Constitution)

## 目的

本ドキュメントは、家計精算アプリ開発における最上位の原則を定義する。
すべてのルール（L-CX, L-RV, L-LC, L-SC, L-OC）はこの基本原則に従属する。

---

## L-CN-001: データ分類体系

### 分類定義

| 分類 | 定義 | 取り扱い | 例 |
|------|------|---------|-----|
| **公開** | 誰でもアクセス可能 | 制限なし | アプリ説明、利用規約 |
| **社内限定** | 開発チームのみ | ログイン必須、外部共有禁止 | 内部ドキュメント、設計書 |
| **機密** | 特定権限者のみ | 暗号化必須、アクセスログ | 環境変数、APIキー |
| **個人情報** | 法的保護対象 | 最小化、暗号化、同意必須 | メールアドレス、取引履歴 |

### データ分類マッピング

| データ | 分類 | 保存場所 | 暗号化 | アクセス制御 |
|--------|------|---------|--------|-------------|
| ユーザーメール | 個人情報 | DB | ✓ | 本人+管理者 |
| ユーザー名 | 個人情報 | DB | - | グループ内 |
| 取引明細 | 個人情報 | DB | ✓ | 本人+パートナー |
| 精算結果 | 個人情報 | DB | - | グループ内 |
| DATABASE_URL | 機密 | 環境変数 | - | CI/本番のみ |
| SESSION_SECRET | 機密 | 環境変数 | - | 本番のみ |
| アプリ利用規約 | 公開 | 静的ファイル | - | 全員 |
| エラーログ | 社内限定 | ログサービス | - | 開発チーム |

### 検証方法

```typescript
// scripts/check-data-classification.ts

const DATA_CLASSIFICATION = {
  PUBLIC: ['terms', 'privacy-policy', 'about'],
  INTERNAL: ['docs/', 'design/', '.md'],
  CONFIDENTIAL: ['DATABASE_URL', 'SESSION_SECRET', 'API_KEY'],
  PII: ['email', 'name', 'transaction', 'amount'],
};

async function validateDataHandling() {
  // 機密データがコードにハードコードされていないか
  // 個人情報が適切に暗号化されているか
  // アクセス制御が分類に従っているか
}
```

---

## L-CN-002: 重大事故の定義

### 事故レベル定義

| レベル | 定義 | 例 | 対応期限 |
|--------|------|-----|---------|
| **P0 (Critical)** | サービス全停止またはデータ漏洩 | DB全体露出、認証バイパス | 即時対応 |
| **P1 (High)** | 主要機能停止または限定的漏洩 | 精算計算不能、特定ユーザーデータ露出 | 4時間以内 |
| **P2 (Medium)** | 一部機能障害 | CSV取り込み失敗、UI表示崩れ | 24時間以内 |
| **P3 (Low)** | 軽微な不具合 | 誤字、パフォーマンス低下 | 次回リリース |

### 重大事故の具体例

**P0 (Critical):**
- 全ユーザーの取引履歴が第三者に閲覧可能
- 認証なしでAPIにアクセス可能
- データベースの完全削除
- 本番環境の秘密鍵漏洩

**P1 (High):**
- 精算金額の計算結果が誤っている
- 特定ユーザーのデータが他ユーザーに表示される
- ログイン不能状態の発生

### エスカレーションフロー

```
┌─────────────────────────────────────────────────────────┐
│                    事故検知                              │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│ レベル判定: P0/P1/P2/P3                                  │
└─────────────────┬───────────────────────────────────────┘
                  │
        ┌─────────┴─────────┐
        ▼                   ▼
   P0/P1の場合           P2/P3の場合
        │                   │
        ▼                   ▼
┌───────────────┐    ┌───────────────┐
│ 即時停止判断   │    │ Issue起票     │
│ (停止権限者)   │    │ 通常対応      │
└───────┬───────┘    └───────────────┘
        │
        ▼
┌───────────────┐
│ 関係者通知     │
│ 対応チーム招集 │
└───────┬───────┘
        │
        ▼
┌───────────────┐
│ 原因調査       │
│ 影響範囲特定   │
└───────┬───────┘
        │
        ▼
┌───────────────┐
│ 復旧/修正      │
│ ポストモーテム │
└───────────────┘
```

### 停止権限

| 権限 | 役割 | 可能な操作 |
|------|------|-----------|
| **緊急停止** | 開発者全員 | 本番デプロイ停止、ロールバック実行 |
| **サービス停止** | プロジェクトオーナー | サービス全体の一時停止 |
| **データ削除** | プロジェクトオーナー | ユーザーデータの削除（法的要請対応） |

### 検証方法

```typescript
// e2e/incident/detection.spec.ts

describe('L-CN-002: 重大事故検知', () => {
  it('認証バイパス試行はP0としてログされる', async () => {
    await attemptAuthBypass();

    const logs = await getSecurityLogs();
    expect(logs).toContainEqual(
      expect.objectContaining({
        level: 'P0',
        type: 'AUTH_BYPASS_ATTEMPT',
      })
    );
  });

  it('精算計算エラーはP1としてアラートされる', async () => {
    await triggerSettlementError();

    const alerts = await getAlerts();
    expect(alerts).toContainEqual(
      expect.objectContaining({
        level: 'P1',
        type: 'SETTLEMENT_CALCULATION_ERROR',
      })
    );
  });
});
```

---

## L-CN-003: AI/エージェント利用ポリシー

### 適用範囲

本ポリシーは以下に適用される：
1. **Coding Agent**: Claude Code等のAIコーディングアシスタント
2. **将来のAI機能**: アプリ内でのAI活用（現時点では該当なし）

### Coding Agent利用ルール

| 操作 | 許可 | 条件 |
|------|------|------|
| コード生成 | ✓ | docs/laws/準拠、レビュー必須 |
| テスト作成 | ✓ | 既存パターン準拠 |
| ドキュメント編集 | ⚠️ 制限付き | docs/laws/以外のみ |
| 機密情報アクセス | ✗ | 環境変数の直接参照禁止 |
| 本番操作 | ✗ | デプロイ・DB操作禁止 |
| ルールドキュメント編集 | ✗ | docs/laws/配下は編集禁止 |

### Coding Agentへの指示

```markdown
## 必須確認事項

コード実装前に以下を確認すること：

1. docs/laws/の該当ルールを参照
2. 既存コードパターンとの整合性
3. テストカバレッジ要件

## 禁止事項

1. docs/laws/配下のファイル編集
2. 環境変数の値をコードにハードコード
3. 本番環境への直接操作
4. ルール衝突時の独自判断による実装続行

## 報告義務

以下の場合は実装を中断しユーザーに報告：

- ルール間の衝突を発見
- ルールが存在しないケースを発見
- セキュリティリスクを発見
```

---

## L-CN-004: ガバナンス構造

### ルール階層

```
┌─────────────────────────────────────────┐
│ L-CN: 基本原則 (Constitution)            │ ← 最上位、他すべてに優先
├─────────────────────────────────────────┤
│ L-LC: 法務・コンプラ                     │ ← 法的拘束力
├─────────────────────────────────────────┤
│ L-SC: セキュリティ                       │ ← システム安全性
├─────────────────────────────────────────┤
│ L-CX: 顧客体験 / L-RV: 収益              │ ← ビジネス要件
├─────────────────────────────────────────┤
│ L-OC: 組織の一貫性                       │ ← 実装標準
└─────────────────────────────────────────┘
```

### ルール衝突時の優先順位

1. **L-CN** (基本原則) > すべて
2. **L-LC** (法務) > L-SC, L-CX, L-RV, L-OC
3. **L-SC** (セキュリティ) > L-CX, L-RV, L-OC
4. **L-CX/L-RV** (ビジネス) > L-OC
5. **L-OC** (実装標準)

### ルール変更プロセス

| 変更種別 | 承認者 | プロセス |
|---------|--------|---------|
| L-CN変更 | プロジェクトオーナー | 全体レビュー必須 |
| L-LC変更 | プロジェクトオーナー | 法務確認必須 |
| L-SC変更 | プロジェクトオーナー | セキュリティレビュー必須 |
| L-CX/RV/OC変更 | 開発チーム合意 | PRレビュー |

---

## CI設定

```yaml
# .github/workflows/constitution.yml

name: Constitution Validation

on: [push, pull_request]

jobs:
  constitution-checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Validate data classification
        run: npx ts-node scripts/check-data-classification.ts

      - name: Check for P0/P1 patterns
        run: npx ts-node scripts/check-critical-patterns.ts

      - name: Verify agent restrictions
        run: npx ts-node scripts/check-agent-restrictions.ts
```

---

## 違反時の対応

| ルール | 違反時対応 |
|--------|-----------|
| L-CN-001 | データ分類違反 → 即座に修正、影響調査 |
| L-CN-002 | 事故対応遅延 → ポストモーテム必須 |
| L-CN-003 | Agent禁止操作 → 操作取り消し、レビュー強化 |
| L-CN-004 | ルール無視 → PR却下、再教育 |
