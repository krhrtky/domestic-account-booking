# 認証機能仕様

## 概要

ユーザー認証（サインアップ、ログイン、ログアウト）とセッション管理を行う機能。

## 関連Laws

| ID | ルール名 | 概要 |
|----|---------|------|
| L-SC-001 | 認証・認可の厳格化 | 全エンドポイントでの検証 |
| L-SC-003 | 機密情報の保護 | パスワードハッシュ化、ログマスキング |
| L-SC-004 | レート制限とDoS対策 | 認証エンドポイントの制限 |
| L-SC-005 | CSRFおよびセッション保護 | Cookie属性、セッション固定攻撃対策 |
| L-CX-003 | エラーメッセージの明確性 | 具体的・対処可能な日本語メッセージ |

## ユースケース

### UC-A01: ユーザー登録（サインアップ）

```
アクター: 新規ユーザー
前提条件: メールアドレスが未登録
トリガー: サインアップフォーム送信

フロー:
1. ユーザーが名前、メールアドレス、パスワードを入力する
2. フォームをサブミットする
3. システムがバリデーションを実行する
4. システムがユーザーを作成する
5. ダッシュボードにリダイレクトする

事後条件: ユーザーアカウントが作成され、ログイン状態となる
```

### UC-A02: ログイン

```
アクター: 登録済みユーザー
前提条件: ユーザーアカウントが存在する
トリガー: ログインフォーム送信

フロー:
1. ユーザーがメールアドレスとパスワードを入力する
2. フォームをサブミットする
3. システムが認証を実行する
4. セッションを作成する
5. ダッシュボードにリダイレクトする

事後条件: ユーザーがログイン状態となる
```

### UC-A03: ログアウト

```
アクター: ログイン中のユーザー
前提条件: ログイン状態
トリガー: ログアウトボタンクリック

フロー:
1. ユーザーがログアウトをクリックする
2. システムがセッションを破棄する
3. ログインページにリダイレクトする

事後条件: ユーザーがログアウト状態となる
```

## 入力バリデーション

### サインアップ入力

| フィールド | 型 | 必須 | バリデーション |
|-----------|-----|------|---------------|
| name | string | ✓ | 1-100文字 |
| email | string | ✓ | メール形式、重複不可 |
| password | string | ✓ | 8文字以上 |

### ログイン入力

| フィールド | 型 | 必須 | バリデーション |
|-----------|-----|------|---------------|
| email | string | ✓ | メール形式 |
| password | string | ✓ | 入力必須 |

## セキュリティ要件

### パスワード要件（L-SC-003）

| 項目 | 要件 |
|------|------|
| 最小長 | 8文字 |
| ハッシュ化 | bcrypt（Supabase Auth） |
| 平文保存 | 禁止 |
| ログ出力 | 禁止 |

### セッション管理（L-SC-005）

| 項目 | 設定 |
|------|------|
| セッション有効期限 | 7日 |
| Cookie: httpOnly | true |
| Cookie: secure | true（本番） |
| Cookie: sameSite | lax |
| セッション固定攻撃対策 | ログイン後にセッションID再生成 |

### レート制限（L-SC-004）

| エンドポイント | 制限 | ウィンドウ |
|--------------|------|-----------|
| /api/auth/login | 5回 | 15分 |
| /api/auth/signup | 3回 | 1時間 |

### CSRF保護（L-SC-005）

Next.js 15 Server Actionsの組み込み保護を使用：

| 保護機構 | 説明 |
|---------|------|
| Originヘッダー検証 | 同一ドメインからのリクエストのみ許可 |
| Action ID検証 | ビルド時生成の暗号学的IDで外部サイトからの呼び出しを防止 |
| セッション認証 | httpOnly + sameSite=lax Cookieによる保護 |

### セキュリティヘッダー

`next.config.js`で設定：

| ヘッダー | 値 | 目的 |
|---------|-----|------|
| X-Frame-Options | DENY | クリックジャッキング防止 |
| Content-Security-Policy | frame-ancestors 'none' | フレーム埋め込み禁止 |
| X-Content-Type-Options | nosniff | MIMEスニッフィング防止 |
| Referrer-Policy | strict-origin-when-cross-origin | リファラー情報制御 |

## 認可マトリクス（L-SC-001）

| リソース | 未認証 | 認証済（グループ外） | 認証済（グループ内） |
|---------|-------|-------------------|-------------------|
| /api/auth/* | ✓ | ✓ | ✓ |
| /api/transactions | ✗ | ✗ | ✓ |
| /api/groups/:id | ✗ | ✗ | ✓ |
| /api/settlement | ✗ | ✗ | ✓ |

### 未認証アクセス時の挙動

| ページ種別 | 挙動 |
|-----------|------|
| 保護ページ | /login にリダイレクト |
| 保護API | 401 Unauthorized |

### グループ外アクセス時の挙動

| リソース種別 | 挙動 |
|-------------|------|
| 他グループのデータ | 403 Forbidden |

## エラー処理

### ユーザー向けエラーメッセージ（L-CX-003）

| エラー条件 | ユーザー向けメッセージ |
|-----------|----------------------|
| 認証失敗 | 「メールアドレスまたはパスワードが正しくありません」 |
| メール重複 | 「このメールアドレスは既に登録されています」 |
| セッション切れ | 「ログインセッションが切れました。再度ログインしてください」 |
| レート制限超過 | 「試行回数が上限に達しました。しばらく待ってから再度お試しください」 |

### 禁止事項

- 「パスワードが間違っています」等、メールの存在を示唆するメッセージ
- 技術的なエラーメッセージの直接表示
- 英語のみのエラーメッセージ

## UI仕様

### ログインページ

| 要素 | 内容 |
|------|------|
| タイトル | 「Log In」 |
| フォーム | メール、パスワード入力 |
| ボタン | 「Log In」→ 送信中「Logging in...」 |
| リンク | サインアップページへ |

### サインアップページ

| 要素 | 内容 |
|------|------|
| タイトル | 「Create Account」 |
| フォーム | 名前、メール、パスワード入力 |
| ボタン | 「Create Account」 |
| リンク | ログインページへ |

### ローディング状態（L-CX-004）

| 操作 | 最大許容時間 | フィードバック |
|------|-------------|---------------|
| ボタンクリック | 100ms | ボタンテキスト変更 |
| 認証処理 | 3秒 | ローディングインジケータ |

## 実装場所

- 認証ロジック: `src/lib/auth.ts`
- セッション管理: `src/lib/session.ts`
- ミドルウェア: `src/middleware.ts`
- レート制限: `src/lib/rate-limiter.ts`

## テスト観点

### 認証テスト

| ケース | 期待結果 |
|--------|----------|
| 正常ログイン | ダッシュボードへリダイレクト |
| 誤パスワード | エラートースト表示 |
| 未登録メール | 同一エラーメッセージ（情報漏洩防止） |
| レート制限超過 | 429エラー、Retry-Afterヘッダー |

### セッションテスト

| ケース | 期待結果 |
|--------|----------|
| 有効セッション | APIアクセス可能 |
| 期限切れセッション | 401エラー |
| ログアウト後 | セッション無効化 |

### 認可テスト

| ケース | 期待結果 |
|--------|----------|
| 未認証で保護ページ | /loginへリダイレクト |
| 他グループデータ取得 | 403エラー |
