# グループ管理機能仕様

## 概要

家計グループの作成、パートナー招待、負担割合設定を行う機能。

## 関連Laws

| ID | ルール名 | 概要 |
|----|---------|------|
| L-BR-005 | グループ管理ルール | 招待フロー・メンバー制限 |
| L-BR-001 | 精算計算ルール | 負担割合の制約 |
| L-SC-001 | 認証・認可の厳格化 | グループ所属検証 |

## ユースケース

### UC-G01: グループ作成

```
アクター: 登録済みユーザー
前提条件: ユーザーがグループに所属していない
トリガー: グループ作成ページでフォーム送信

フロー:
1. ユーザーがグループ名を入力する
2. ユーザーが負担割合（Ratio A）を入力する
3. システムがRatio Bを自動計算する（100 - Ratio A）
4. グループが作成される
5. ユーザーがuser_a_idとして登録される

事後条件: グループが作成され、ユーザーがグループに所属する
```

### UC-G02: パートナー招待

```
アクター: グループ作成者（UserA）
前提条件: グループが作成済み、UserBが未登録
トリガー: 招待フォームでメールアドレス入力

フロー:
1. ユーザーがパートナーのメールアドレスを入力する
2. 招待ボタンをクリックする
3. システムが招待URLを生成する
4. 招待URLが画面に表示される
5. （別途）パートナーが招待URLからサインアップ/参加する

事後条件: 招待URLが発行される
```

### UC-G03: グループ参加

```
アクター: 招待されたユーザー
前提条件: 有効な招待URLを持っている
トリガー: 招待URLにアクセス

フロー:
1. ユーザーがサインアップ/ログインする
2. システムがユーザーをグループに追加する
3. ユーザーがuser_b_idとして登録される

事後条件: ユーザーがグループのメンバーとなる
```

### UC-G04: 負担割合変更

```
アクター: グループメンバー
前提条件: グループに所属している
トリガー: 設定ページで割合変更

フロー:
1. ユーザーがRatio Aを変更する
2. システムがRatio Bを自動計算する
3. 設定が保存される

事後条件: 負担割合が更新される
```

## データモデル

### Group型

```typescript
interface Group {
  id: string;
  name: string;
  ratio_a: number;    // 0-100の整数
  ratio_b: number;    // 0-100の整数（100 - ratio_a）
  user_a_id: string;
  user_b_id?: string; // 招待前はundefined
  created_at: string;
  updated_at: string;
}
```

## 制約・バリデーション

### グループ構成制約（L-BR-005）

| 項目 | 値 | 根拠 |
|------|-----|------|
| 最大メンバー数 | 2名 | MVP仕様 |
| 最小メンバー数 | 1名（招待待ち状態） | 招待フロー |
| グループ数/ユーザー | 1 | 複数グループ不可 |

### 招待制約

| 項目 | 値 |
|------|-----|
| 招待有効期限 | 7日間 |
| 招待取り消し | 発行者がいつでも可能 |
| 同一メール再招待 | 可能（前回の招待は無効化） |

### 負担割合制約（L-BR-001）

| 制約 | 値 | バリデーション |
|------|-----|---------------|
| 合計 | 100% | ratio_a + ratio_b = 100 |
| 最小単位 | 1% | 整数のみ |
| 範囲 | 0-100% | 0 < ratio_a < 100 |

## 権限モデル

### グループ操作権限

| 操作 | UserA（作成者） | UserB（招待者） | 非メンバー |
|------|----------------|----------------|-----------|
| グループ情報参照 | ✓ | ✓ | ✗ |
| 負担割合変更 | ✓ | ✓ | ✗ |
| パートナー招待 | ✓ | ✗ | ✗ |
| グループ脱退 | ✓ | ✓ | ✗ |

### グループ脱退後の挙動

| 項目 | 挙動 |
|------|------|
| 取引データ | 残る |
| グループ | メンバー0で自動削除 |
| 再参加 | 新規招待が必要 |

## API仕様

### POST /api/groups/create

グループ作成

**入力:**
```json
{
  "name": "string",
  "ratio_a": "number (1-99)"
}
```

**出力:**
```json
{
  "success": true,
  "data": {
    "group_id": "string"
  }
}
```

### POST /api/groups/invite

パートナー招待

**入力:**
```json
{
  "email": "string"
}
```

**出力:**
```json
{
  "success": true,
  "data": {
    "invitation_url": "string"
  }
}
```

### PATCH /api/groups/ratio

負担割合変更

**入力:**
```json
{
  "ratio_a": "number (1-99)"
}
```

## エラー処理

| エラー条件 | ユーザー向けメッセージ |
|-----------|----------------------|
| 既にグループ所属 | 「既にグループに所属しています」 |
| 招待先が既にグループ所属 | 「このユーザーは既に他のグループに所属しています」 |
| 無効な招待URL | 「招待の有効期限が切れています」 |
| 負担割合の合計≠100 | 「負担割合の合計は100%である必要があります」 |
| グループ未所属でアクセス | 「グループに所属していません」 |

## テスト観点

### グループ作成テスト

| ケース | 期待結果 |
|--------|----------|
| 正常作成 | グループ作成、user_a_id設定 |
| 既にグループ所属 | エラー返却 |
| ratio_a = 50 | ratio_b = 50で作成 |
| ratio_a = 0 | エラー返却 |

### 招待テスト

| ケース | 期待結果 |
|--------|----------|
| 正常招待 | 招待URL発行 |
| 招待URL参加 | user_b_id設定 |
| 期限切れURL | エラー返却 |
| 既存メンバーの招待先 | エラー返却 |

### 権限テスト

| ケース | 期待結果 |
|--------|----------|
| 非メンバーのグループアクセス | 403エラー |
| UserBの招待操作 | 403エラー（将来緩和可能） |
