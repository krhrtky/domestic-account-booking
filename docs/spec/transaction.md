# 取引管理機能仕様

## 概要

取引（支出）データの登録・管理を行う機能。CSV取り込み、手動入力、分類変更、削除を含む。

## 関連Laws

| ID | ルール名 | 概要 |
|----|---------|------|
| L-BR-003 | 支出タイプ（ExpenseType）ルール | Household/Personalの分類 |
| L-BR-006 | CSV取り込みルール | フォーマット・列マッピング・重複検知 |
| L-LC-001 | 個人情報の適切な取り扱い | カード/口座番号の除外 |
| L-SC-002 | インジェクション対策 | CSV数式インジェクション対策 |
| L-RV-002 | インフラコストの制御 | ファイルサイズ・行数制限 |

## ユースケース

### UC-T01: CSVファイルからの取引取り込み

```
アクター: グループメンバー
前提条件: グループに所属している
トリガー: CSVアップロードページでファイル選択

フロー:
1. ユーザーがCSVファイルを選択する
2. ユーザーが支払元（Payer）を選択する
3. システムがCSVをパースする
4. 列マッピングを自動検出する
5. 取引データをDBに保存する
6. 結果を表示する（成功件数、エラー件数）

事後条件: 取引データがグループに紐付いて保存される
```

### UC-T02: 取引の支出タイプ変更

```
アクター: グループメンバー
前提条件: 取引データが存在する
トリガー: 取引一覧でトグル操作

フロー:
1. ユーザーが取引のHousehold/Personalトグルを操作する
2. システムがexpense_typeを更新する
3. UIが更新状態を反映する

事後条件: 取引の支出タイプが変更される
```

### UC-T03: 取引の削除

```
アクター: グループメンバー
前提条件: 取引データが存在する
トリガー: 削除ボタンクリック

フロー:
1. ユーザーが削除ボタンをクリックする
2. 確認ダイアログを表示する
3. ユーザーが確認する
4. システムが取引を削除する

事後条件: 取引がDBから削除される
```

## データモデル

### Transaction型

```typescript
interface Transaction {
  id: string;
  group_id: string;
  user_id: string;
  date: string;           // YYYY-MM-DD
  amount: number;         // 正の整数（円）
  description: string;    // 最大200文字
  payer_type: PayerType;  // 'UserA' | 'UserB' | 'Common'
  expense_type: ExpenseType; // 'Household' | 'Personal'
  source_file_name?: string;
  uploaded_by?: string;
  created_at: string;
  updated_at: string;
}
```

### 支出タイプ（ExpenseType）の定義（L-BR-003）

| ExpenseType | 説明 | 精算対象 |
|-------------|------|---------|
| Household | 家計・共有の支出 | ✓ 対象 |
| Personal | 個人の支出 | ✗ 対象外 |

### 分類ガイドライン

| カテゴリ | 典型例 | 推奨ExpenseType |
|---------|--------|----------------|
| 食費（共同） | スーパー、外食（二人） | Household |
| 食費（個人） | 個人のランチ、趣味の食材 | Personal |
| 住居費 | 家賃、光熱費、インターネット | Household |
| 日用品 | トイレットペーパー、洗剤 | Household |
| 趣味・娯楽（個人） | 個人の書籍、ゲーム | Personal |
| 趣味・娯楽（共同） | 二人で見る映画、旅行 | Household |

## CSV取り込み仕様（L-BR-006）

### 対応フォーマット

| 項目 | 要件 |
|------|------|
| 文字コード | UTF-8（BOMあり/なし両対応） |
| 区切り文字 | カンマ（,） |
| ヘッダー行 | 必須 |
| 必須列 | 日付, 金額 |
| 推奨列 | 摘要/メモ |

### 列マッピング（自動検出）

| CSVヘッダー例 | マッピング先 |
|--------------|-------------|
| 日付, 利用日, Date | date |
| 金額, 利用金額, Amount | amount |
| 摘要, 内容, メモ, Description | description |

### 日付フォーマット対応

- `YYYY-MM-DD` (例: 2025-01-15)
- `YYYY/MM/DD` (例: 2025/01/15)
- `MM/DD/YYYY` (例: 01/15/2025)

### 金額パース

- カンマ区切り対応（例: 10,000 → 10000）
- 円記号対応（例: ¥5,000 → 5000）
- 負の値は絶対値に変換

## 制約・バリデーション

### ファイル制約（L-RV-002）

| 制約 | 値 | 根拠 |
|------|-----|------|
| ファイルサイズ上限 | 5MB | インフラコスト制御 |
| 行数上限 | 10,000行 | インフラコスト制御 |

### 重複検知

| 項目 | 内容 |
|------|------|
| 重複判定キー | 日付 + 金額 + 摘要 |
| 重複時の動作 | 警告表示（取り込みは実行） |
| 根拠 | ユーザー判断優先 |

### セキュリティ対策

#### 個人情報除外（L-LC-001）

以下のパターンを含む列は自動除外:
- カード番号
- 口座番号
- Card Number
- Account Number

#### CSVインジェクション対策（L-SC-002）

| 対象 | 処理 |
|------|------|
| 数式インジェクション | `=`, `+`, `-`, `@` で始まるフィールドを `'` でエスケープ |
| 改行インジェクション | 埋め込み改行を除去 |

## エラー処理

| エラー条件 | ユーザー向けメッセージ |
|-----------|----------------------|
| 空ファイル | 「CSVファイルが空です」 |
| サイズ超過 | 「ファイルサイズが5MBを超えています」 |
| 必須列なし | 「日付列または金額列が見つかりません」 |
| パースエラー | 「CSVファイルの形式が正しくありません」 |
| データ行なし | 「有効なデータ行が見つかりません」 |

## 実装場所

- CSVパーサー: `src/lib/csv-parser.ts`
- 取引API: `src/app/api/transactions/`

## テスト観点

### CSVパーステスト

| ケース | 期待結果 |
|--------|----------|
| 正常なCSV | 全行パース成功 |
| 日本語ヘッダー | 列マッピング成功 |
| 日付形式混在 | 正規化されて取り込み |
| 空ファイル | エラー返却 |
| 5MB超過 | エラー返却 |

### 分類変更テスト

| ケース | 期待結果 |
|--------|----------|
| Household → Personal | expense_type更新 |
| Personal → Household | expense_type更新 |

### セキュリティテスト

| ケース | 期待結果 |
|--------|----------|
| =CMD|calc.exe|A0 | エスケープされる |
| 改行を含む摘要 | 改行除去 |
| カード番号列 | 列自体が除外 |
