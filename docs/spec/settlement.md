# 精算機能仕様

## 概要

家計グループの月次精算金額を算出し、「誰が誰にいくら支払うべきか」を決定する機能。

## 関連Laws

| ID | ルール名 | 概要 |
|----|---------|------|
| L-BR-001 | 精算計算ルール | シンプルモデル・端数処理・負担割合制約 |
| L-BR-002 | 支払元（Payer）ルール | UserA/UserB/Commonの定義と計算影響 |
| L-CX-001 | 精算金額の正確性 | 定義されたロジックに100%準拠 |
| L-OC-002 | 精算ロジックの単一実装 | settlement.tsへの集約 |

## ユースケース

### UC-S01: 月次精算金額の確認

```
アクター: グループメンバー
前提条件: グループに所属し、当月の取引データが存在する
トリガー: ダッシュボードで月を選択

フロー:
1. ユーザーが対象月を選択する
2. システムが当月のHousehold取引を集計する
3. 精算計算を実行する
4. 結果を表示する（誰が誰にいくら支払うか）

事後条件: 精算結果が画面に表示される
```

### UC-S02: 精算根拠の確認（L-BR-007）

```
アクター: グループメンバー
前提条件: 精算結果が表示されている
トリガー: 「詳細を見る」をクリック

フロー:
1. システムが精算金額の内訳を表示する
2. 内訳には以下が含まれる:
   - Householdとして計上された全明細一覧
   - 各明細の金額と支払元（Payer）
   - PaidByA合計, PaidByB合計
   - 適用された負担割合
   - 計算式の適用結果
3. ユーザーは任意の明細をクリックして詳細を確認できる

事後条件: ユーザーは精算金額の算出根拠を理解できる
```

## 入出力仕様

### 入力

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| targetMonth | string | ✓ | 対象月（YYYY-MM形式） |
| transactions | Transaction[] | ✓ | グループの取引データ |
| group | Group | ✓ | グループ情報（負担割合含む） |

### 出力（Settlement型）

| フィールド | 型 | 説明 |
|-----------|-----|------|
| month | string | 対象月 |
| total_household | number | 家計支出合計（UserA + UserB） |
| paid_by_a_household | number | UserAが支払った家計支出 |
| paid_by_b_household | number | UserBが支払った家計支出 |
| paid_by_common | number | 共通口座からの支払い（参考値） |
| balance_a | number | Aの収支（正:受取、負:支払） |
| ratio_a | number | Aの負担割合 |
| ratio_b | number | Bの負担割合 |

## 計算ロジック

### 精算計算式（L-BR-001）

```
Balance_A = PaidBy_A^{Household} - ((PaidBy_A^{Household} + PaidBy_B^{Household}) × Ratio_A)
```

### 結果の解釈

| 条件 | 結果 |
|------|------|
| Balance_A > 0 | BがAに Balance_A を支払う |
| Balance_A < 0 | AがBに |Balance_A| を支払う |
| Balance_A = 0 | 精算不要 |

### 支払元（Payer）の影響（L-BR-002）

| Payer | 精算計算への影響 |
|-------|-----------------|
| UserA | Balance計算に含む |
| UserB | Balance計算に含む |
| Common | Balance計算から除外（参考表示のみ） |

## 制約・バリデーション

### 負担割合制約

| 制約 | 値 | 根拠 |
|------|-----|------|
| 負担割合の合計 | 100% | 論理的整合性 |
| 負担割合の最小単位 | 1% | UI/UX簡素化 |
| 負担割合の範囲 | 0-100% | バリデーション |

### 端数処理

| 処理 | 方法 | 根拠 |
|------|------|------|
| 端数処理 | 四捨五入（Math.round） | 公平性（L-BR-001） |
| 金額の最小単位 | 1円 | 日本円の最小単位 |

### 月フォーマット

- 形式: YYYY-MM（例: 2025-01）
- 不正形式は例外をスロー

## エラー処理

| エラー条件 | エラーメッセージ |
|-----------|----------------|
| 負担割合の合計 ≠ 100% | 「負担割合の合計は100%である必要があります」 |
| 不正な月フォーマット | 「Invalid month format. Expected YYYY-MM」 |
| ratio_a が範囲外 | 「ratio_a must be between 0 and 100」 |

## 実装場所

**正規実装**: `src/lib/settlement.ts`

他の場所での再実装は禁止（L-OC-002）。

## テスト観点

### 基本計算テスト

| ケース | 入力 | 期待結果 |
|--------|------|----------|
| 50:50で均等払い | A:60k, B:40k | balance=10k（B→A） |
| 60:40で一方が多く払う | A:80k, B:20k, 60:40 | balance=20k（B→A） |
| 50:50で逆払い | A:30k, B:70k | balance=-20k（A→B） |
| Common口座のみ | Common:50k | balance=0 |
| Personal除外 | A:50k(H)+30k(P), B:50k(H) | balance=0 |

### エッジケーステスト

- 取引なし → balance=0
- 端数が発生する割合（33:67など）→ 整数に丸められる
- 負担割合100:0 → 全額相手負担

### バリデーションテスト

- 負担割合の合計が100%以外 → エラー
- 不正な月フォーマット → エラー
