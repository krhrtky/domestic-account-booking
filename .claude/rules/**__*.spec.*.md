# E2E/Spec Test Rules

This rule applies to all spec test files (`**/*.spec.*`).

## Applicable Laws

Reference: [docs/laws/07-test-audit.md](../../docs/laws/07-test-audit.md)

### L-TA-001: Evaluation Dataset Categories

E2E tests must cover:

| Category | Purpose | Examples |
|----------|---------|----------|
| Typical | User journey happy path | Login → View → Settlement |
| Boundary | Limit testing | Max file size, many transactions |
| Incident | Past bug reproductions | Specific regression tests |
| Gray | Edge case UI behavior | Empty states, loading states |
| Attack | Security scenarios | Auth bypass, XSS attempts |

### L-BR-007: Traceability Testing

E2E tests must verify audit traceability:

#### UC-001: Settlement Breakdown Confirmation
```typescript
test('精算結果から明細一覧を確認できる', async ({ page }) => {
  await page.goto('/settlement?month=2025-01');
  await page.getByRole('button', { name: '詳細を見る' }).click();

  await expect(page.getByTestId('breakdown-panel')).toBeVisible();
  await expect(page.getByTestId('paid-by-a-total')).toHaveText(/¥[\d,]+/);
  await expect(page.getByTestId('paid-by-b-total')).toHaveText(/¥[\d,]+/);
  await expect(page.getByTestId('calculation-formula')).toBeVisible();
});
```

#### UC-002: Past Settlement Trace
```typescript
test('過去月の精算根拠を確認できる', async ({ page }) => {
  await page.goto('/settlement?month=2024-12');
  // Same verification as UC-001
});
```

### L-CX-004: Performance Testing

```typescript
test('ボタンクリックは100ms以内にフィードバック', async ({ page }) => {
  const startTime = Date.now();
  await page.getByRole('button', { name: 'アップロード' }).click();
  await expect(page.getByTestId('loading-indicator')).toBeVisible();
  expect(Date.now() - startTime).toBeLessThan(100);
});
```

### L-SC-001: Authorization Testing

```typescript
describe('認証・認可テスト', () => {
  test('未認証で保護ページにアクセスするとリダイレクト', async ({ page }) => {
    await page.goto('/dashboard');
    await expect(page).toHaveURL(/\/login/);
  });

  test('他グループのデータにアクセスすると403', async ({ page }) => {
    const response = await page.goto('/api/groups/other-group-id');
    expect(response?.status()).toBe(403);
  });
});
```

### L-TA-003: Red Team E2E Scenarios

```typescript
describe('セキュリティE2Eテスト', () => {
  test('XSSペイロードがエスケープされる', async ({ page }) => {
    await page.fill('[name="description"]', '<script>alert("xss")</script>');
    await page.click('button[type="submit"]');

    const content = await page.content();
    expect(content).not.toContain('<script>');
  });

  test('CSRFトークンなしのPOSTは拒否', async ({ page, request }) => {
    const response = await request.post('/api/transactions', {
      data: { amount: 1000 }
      // No CSRF token
    });
    expect(response.status()).toBe(403);
  });
});
```

### Visual Regression Testing

```typescript
test('精算画面のビジュアル一貫性', async ({ page }) => {
  await page.goto('/settlement');
  await expect(page).toHaveScreenshot('settlement-dashboard.png');
});
```
